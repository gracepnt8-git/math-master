<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sçº§ç‰¹è®­ï¼šå…¨é—­ç¯æ™ºèƒ½æ•™å­¦ç³»ç»Ÿ</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js"></script>

    <style>
        :root {
            --primary: #1565c0; /* æ•™å­¦è“ */
            --quiz: #2e7d32;    /* æµ‹è¯•ç»¿ */
            --remedy: #f57c00;  /* è¡¥æ•‘æ©™ */
            --deep: #c62828;    /* æ·±åº¦çº¢ */
            --bg: #f4f6f8;
            --card: #ffffff;
        }

        body { font-family: 'Segoe UI', 'PingFang SC', sans-serif; background: var(--bg); margin: 0; padding: 20px; line-height: 1.6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* åœºæ™¯åˆ‡æ¢åŠ¨ç”» */
        .scene { display: none; animation: fadeIn 0.5s; }
        .scene.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card { background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; position: relative; }
        
        h1, h2, h3 { margin-top: 0; color: #2c3e50; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-block; padding: 12px 24px; border-radius: 6px; cursor: pointer; border: none; font-size: 1rem; color: white; transition: 0.2s;
            width: 100%; text-align: left; margin-bottom: 10px;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); text-align: center; font-weight: bold; width: auto; }
        
        /* é€‰é¡¹æŒ‰é’® */
        .btn-opt { background: white; color: #333; border: 2px solid #e0e0e0; }
        .btn-opt:hover { background: #e3f2fd; border-color: var(--primary); }
        .btn-opt.selected { background: #e3f2fd; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .disabled { pointer-events: none; opacity: 0.6; }

        /* --- Phase 1 æ•™å­¦åŒºæ ·å¼ --- */
        .study-header { border-left: 5px solid var(--primary); padding-left: 15px; margin-bottom: 20px; }
        .knowledge-point {
            background: #e1f5fe; border: 1px dashed var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 15px;
        }
        .key-tag { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 5px; }

        /* --- Phase 3 è¡¥æ•‘åŒºæ ·å¼ --- */
        .remedy-header { background: #fff3e0; color: #e65100; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffe0b2; }
        
        /* æ·±åº¦å¹²é¢„ç›’å­ */
        .deep-dive-box {
            display: none; /* é»˜è®¤éšè— */
            background: #ffebee; border: 2px dashed var(--deep); padding: 15px; border-radius: 8px; margin-top: 15px;
            animation: slideDown 0.5s;
        }
        @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

        .step-item { margin-bottom: 8px; padding-left: 10px; border-left: 3px solid var(--deep); }

        /* è¿›åº¦æ¡ */
        .progress-bar { height: 8px; background: #e0e0e0; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--quiz); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="container">

    <div id="scene-study" class="scene active">
        <div class="card">
            <div class="study-header">
                <h1>ç¬¬ä¸€æ­¥ï¼šSçº§è€ƒç‚¹å¤ä¹ </h1>
                <p>åœ¨å¼€å§‹æµ‹è¯•å‰ï¼Œè¯·ç¡®ä¿ä½ å·²ç»æ­»è®°ç¡¬èƒŒäº†ä»¥ä¸‹ 4 ä¸ªæ ¸å¿ƒé“å¾‹ã€‚</p>
            </div>
            
            <div class="knowledge-point">
                <h3><span class="key-tag">S-01</span>å®šä¹‰é“å¾‹</h3>
                <p>äºŒæ¬¡å‡½æ•° $y=ax^2+bx+c$ å¿…é¡»æ»¡è¶³ï¼š</p>
                <ul>
                    <li><strong>$a \neq 0$</strong> (äºŒæ¬¡é¡¹ç³»æ•°ä¸èƒ½ä¸º0)</li>
                    <li>$x$ çš„æœ€é«˜æ¬¡æ•°å¿…é¡»æ˜¯ <strong>2</strong></li>
                    <li>å¿…é¡»æ˜¯æ•´å¼ (åˆ†æ¯ä¸­ä¸èƒ½æœ‰æœªçŸ¥æ•°)</li>
                </ul>
            </div>

            <div class="knowledge-point">
                <h3><span class="key-tag">S-02</span>é¡¶ç‚¹å¼å£è¯€</h3>
                <p>å¯¹äº $y=a(x-h)^2+k$ï¼š</p>
                <ul>
                    <li>é¡¶ç‚¹åæ ‡æ˜¯ <strong>$(h, k)$</strong></li>
                    <li><strong>è®°å¿†å£è¯€ï¼š</strong>æ‹¬å·é‡Œé¢â€œå·¦åŠ å³å‡â€ï¼ˆç¬¦å·è¦å˜ï¼‰ï¼Œæ‹¬å·å¤–é¢ç¬¦å·ä¸å˜ã€‚</li>
                    <li>ä¾‹ï¼š$y=2(x+3)^2-5$ çš„é¡¶ç‚¹æ˜¯ $(-3, -5)$ã€‚</li>
                </ul>
            </div>

            <div class="knowledge-point">
                <h3><span class="key-tag">S-03</span>å¾…å®šç³»æ•°æ³•ç­–ç•¥</h3>
                <ul>
                    <li>å·²çŸ¥ <strong>é¡¶ç‚¹</strong> $(h,k)$ $\rightarrow$ è®¾ <strong>é¡¶ç‚¹å¼</strong> (æœ€å¿«)</li>
                    <li>å·²çŸ¥ <strong>ä¸‰ç‚¹</strong> $\rightarrow$ è®¾ <strong>ä¸€èˆ¬å¼</strong> (æœ€æ…¢)</li>
                    <li>å·²çŸ¥ <strong>ä¸xè½´äº¤ç‚¹</strong> $\rightarrow$ è®¾ <strong>äº¤ç‚¹å¼</strong></li>
                </ul>
            </div>

            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="startQuiz()">æˆ‘å·²æŒæ¡ï¼Œå¼€å§‹æµ‹è¯• â¡</button>
        </div>
    </div>

    <div id="scene-quiz" class="scene">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold; color:var(--quiz);">Sçº§ è¾¾æ ‡æµ‹è¯•</span>
                <span id="quiz-progress-text">1 / 6</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="quiz-progress-fill"></div></div>

            <h3 id="quiz-question-text">...</h3>
            <div id="quiz-options-container"></div>
            
            <button id="quiz-next-btn" class="btn btn-primary" style="margin-top:20px; display:none;">ä¸‹ä¸€é¢˜</button>
        </div>
    </div>

    <div id="scene-remedy" class="scene">
        <div class="card" style="border-top: 5px solid var(--remedy);">
            <div class="remedy-header">
                <h3>âš ï¸ æ™ºèƒ½é”™é¢˜è¯Šç–—</h3>
                <p>ç³»ç»Ÿæ£€æµ‹åˆ°çŸ¥è¯†ç›²åŒºã€‚è¯·å®Œæˆä»¥ä¸‹ä¸‰æ­¥ä¿®å¤æµç¨‹ã€‚</p>
            </div>

            <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <p><strong>âŒ åŸé¢˜å›é¡¾ï¼š</strong> <span id="remedy-original-question">...</span></p>
                <div style="background:#fff8e1; padding:15px; border-radius:8px; color:#555;">
                    <strong>ğŸ“– è€å¸ˆè§£æï¼š</strong> <span id="remedy-explanation">...</span>
                </div>
            </div>

            <h4 style="color:var(--remedy);">âœï¸ å˜å¼é¢˜æŒ‘æˆ˜ (è¯æ˜ä½ æ‡‚äº†)ï¼š</h4>
            <p id="variant-question-text" style="font-weight:bold;">...</p>
            <div id="variant-options-container"></div>
            
            <div id="deep-dive-box" class="deep-dive-box">
                <h4 style="color:var(--deep); margin-top:0;">ğŸš¨ ä¾ç„¶åšé”™ï¼Ÿå¯åŠ¨ã€åˆ†æ­¥æ‹†è§£ã€‘æ¨¡å¼</h4>
                <div id="deep-steps"></div>
                <div style="margin-top:15px; text-align:right;">
                    <button class="btn btn-primary" style="background:var(--deep); width:auto;" onclick="retryVariant()">ğŸ”„ æˆ‘çœ‹æ‡‚äº†ï¼Œé‡åšæ­¤é¢˜</button>
                </div>
            </div>

            <div id="variant-feedback" style="margin-top:15px; font-weight:bold; min-height:30px;"></div>
            
            <button id="remedy-next-btn" class="btn btn-primary" style="margin-top:20px; display:none;" onclick="nextRemedyItem()">ä¸‹ä¸€é¡¹è¯Šæ–­ â¡</button>
        </div>
    </div>

    <div id="scene-result" class="scene">
        <div class="card" style="text-align: center;">
            <div style="font-size: 4em; margin-bottom: 10px;">ğŸ‰</div>
            <h2>ç‰¹è®­ç»“æŸ</h2>
            <div id="result-details" style="text-align: left; margin: 20px 0; background: #f5f5f5; padding: 20px; border-radius: 8px;"></div>
            <button class="btn btn-primary" onclick="location.reload()">é‡æ–°å¼€å§‹å­¦ä¹ </button>
        </div>
    </div>

</div>

<script>
    // =========================================================
    // æ•°æ®ä¸­å¿ƒï¼šåŒ…å«é¢˜ç›®ã€è§£æã€å˜å¼é¢˜ã€åˆ†æ­¥æ‹†è§£
    // =========================================================
    const questionBank = [
        {
            id: "S-01", type: "main",
            question: "ä¸‹åˆ—å‡½æ•°ä¸­ï¼Œå±äº<strong>äºŒæ¬¡å‡½æ•°</strong>çš„æ˜¯ï¼Ÿ",
            options: ["$ y = 2x - 1 $", "$ y = (x-1)^2 - x^2 $", "$ y = \\frac{1}{x^2} + 2 $", "$ y = 1 - 3x^2 $"],
            correct: 3, 
            remediation: {
                explanation: "<strong>åˆ¤æ®ï¼š</strong>1.æ•´å¼ï¼›2.æœ€é«˜æ¬¡æ•°ä¸º2ï¼›3.äºŒæ¬¡é¡¹ç³»æ•° $a\\neq0$ã€‚<br>Bé€‰é¡¹åŒ–ç®€åæ˜¯ $-2x+1$ (ä¸€æ¬¡)ï¼›Cé€‰é¡¹æ˜¯åˆ†å¼ï¼›åªæœ‰Dç¬¦åˆã€‚",
                variant: {
                    question: "è‹¥ $ y = (m-2)x^2 + 3x $ æ˜¯äºŒæ¬¡å‡½æ•°ï¼Œåˆ™ $ m $ çš„èŒƒå›´ï¼Ÿ",
                    options: ["$ m = 2 $", "$ m \\neq 2 $", "$ m > 2 $", "ä»»æ„å®æ•°"],
                    correct: 1
                },
                stepByStep: [
                    "ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ° $x^2$ çš„ç³»æ•°ï¼Œè¿™é‡Œæ˜¯ $m-2$ã€‚",
                    "ç¬¬äºŒæ­¥ï¼šæ ¹æ®å®šä¹‰ $a \\neq 0$ï¼Œåˆ—å‡ºä¸ç­‰å¼ $m-2 \\neq 0$ã€‚",
                    "ç¬¬ä¸‰æ­¥ï¼šè§£ä¸ç­‰å¼ï¼Œå¾— $m \\neq 2$ã€‚"
                ]
            }
        },
        {
            id: "S-02", type: "main",
            question: "æŠ›ç‰©çº¿ $ y = -2(x+3)^2 - 5 $ çš„<strong>é¡¶ç‚¹åæ ‡</strong>æ˜¯ï¼Ÿ",
            options: ["$ (3, 5) $", "$ (-3, 5) $", "$ (-3, -5) $", "$ (3, -5) $"],
            correct: 2, 
            remediation: {
                explanation: "<strong>å£è¯€ï¼š</strong>æ‹¬å·é‡Œé¢å˜å·ï¼Œæ‹¬å·å¤–é¢ä¸å˜ã€‚<br>$(x+3)$ å˜å·å¾— $-3$ï¼Œå°¾å·´ $-5$ ç…§æŠ„ã€‚",
                variant: {
                    question: "å·²çŸ¥æŠ›ç‰©çº¿é¡¶ç‚¹æ˜¯ $(2, -4)$ï¼Œè§£æå¼å¯èƒ½æ˜¯ï¼Ÿ",
                    options: ["$ y=2(x+2)^2-4 $", "$ y=2(x-2)^2-4 $", "$ y=2(x-2)^2+4 $", "$ y=2(x+2)^2+4 $"],
                    correct: 1
                },
                stepByStep: [
                    "ç¬¬ä¸€æ­¥ï¼šæ¨ªåæ ‡æ˜¯ $2$ï¼Œæ”¾å…¥æ‹¬å·è¦å˜å·ï¼Œå˜æˆ $(x-2)^2$ã€‚",
                    "ç¬¬äºŒæ­¥ï¼šçºµåæ ‡æ˜¯ $-4$ï¼Œæ”¾åœ¨å°¾å·´ä¸å˜å·ï¼Œå°±æ˜¯ $-4$ã€‚",
                    "ç¬¬ä¸‰æ­¥ï¼šç»„åˆèµ·æ¥ï¼Œæ‰¾å«æœ‰ $(x-2)^2-4$ çš„é€‰é¡¹ã€‚"
                ]
            }
        },
        {
            id: "S-03", type: "main",
            question: "å°†ä¸€èˆ¬å¼ $ y = x^2 - 4x + 3 $ åŒ–ä¸ºé¡¶ç‚¹å¼ï¼Ÿ",
            options: ["$ y = (x-2)^2 - 1 $", "$ y = (x-2)^2 + 3 $", "$ y = (x+2)^2 - 1 $", "$ y = (x-2)^2 + 7 $"],
            correct: 0, 
            remediation: {
                explanation: "é…æ–¹æ ¸å¿ƒï¼šåŠ ä¸Šä¸€æ¬¡é¡¹ç³»æ•°ä¸€åŠçš„å¹³æ–¹ã€‚<br>$-4$ çš„ä¸€åŠæ˜¯ $-2$ï¼Œå¹³æ–¹æ˜¯ $4$ã€‚<br>$y=(x^2-4x+4)-4+3 = (x-2)^2-1$ã€‚",
                variant: {
                    question: "æŠ›ç‰©çº¿ $ y = x^2 + 6x + 5 $ çš„å¯¹ç§°è½´æ˜¯ï¼Ÿ",
                    options: ["$ x = 3 $", "$ x = -3 $", "$ x = 6 $", "$ x = -6 $"],
                    correct: 1
                },
                stepByStep: [
                    "ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«ç³»æ•° $a=1, b=6$ã€‚",
                    "ç¬¬äºŒæ­¥ï¼šä½¿ç”¨å¯¹ç§°è½´å…¬å¼ $x = -\\frac{b}{2a}$ã€‚",
                    "ç¬¬ä¸‰æ­¥ï¼šä»£å…¥è®¡ç®— $x = -\\frac{6}{2} = -3$ã€‚"
                ]
            }
        },
        {
            id: "S-04", type: "main",
            question: "å·²çŸ¥æŠ›ç‰©çº¿<strong>é¡¶ç‚¹</strong>ä¸º $(1, 4)$ï¼Œä¸”è¿‡ç‚¹ $(0, 3)$ï¼Œè®¾è§£æå¼é¦–é€‰ï¼Ÿ",
            options: ["$ y = ax^2+bx+c $", "$ y = a(x-1)^2+4 $", "$ y = a(x+1)^2+4 $", "$ y = a(x-1)(x-2) $"],
            correct: 1, 
            remediation: {
                explanation: "æœ‰é¡¶ç‚¹ï¼Œå¿…è®¾é¡¶ç‚¹å¼ $y=a(x-h)^2+k$ã€‚è¿™é‡Œ $h=1, k=4$ã€‚",
                variant: {
                    question: "è‹¥æŠ›ç‰©çº¿é¡¶ç‚¹æ˜¯åŸç‚¹ $(0,0)$ï¼Œè§£æå¼è®¾ä¸ºï¼Ÿ",
                    options: ["$ y=ax^2+bx $", "$ y=ax^2+c $", "$ y=ax^2 $", "$ y=a(x-1)^2 $"],
                    correct: 2
                },
                stepByStep: [
                    "ç¬¬ä¸€æ­¥ï¼šé¡¶ç‚¹ $(0,0)$ ä»£å…¥é¡¶ç‚¹å¼ $y=a(x-0)^2+0$ã€‚",
                    "ç¬¬äºŒæ­¥ï¼šåŒ–ç®€ $(x-0)$ å°±æ˜¯ $x$ã€‚",
                    "ç¬¬ä¸‰æ­¥ï¼šå¾—åˆ° $y=ax^2$ã€‚"
                ]
            }
        },
        {
            id: "S-Mix-01", type: "main",
            question: "è‹¥ $ y = (m-2)x^{m^2-2} $ æ˜¯äºŒæ¬¡å‡½æ•°ï¼Œåˆ™ $m$ï¼Ÿ",
            options: ["$ 2 $", "$ -2 $", "$ \\pm 2 $", "$ 0 $"],
            correct: 1, 
            remediation: {
                explanation: "åŒé‡é™åˆ¶ï¼š1.æ¬¡æ•° $m^2-2=2 \\Rightarrow m=\\pm 2$ï¼›<br>2.ç³»æ•° $m-2 \\neq 0 \\Rightarrow m \\neq 2$ã€‚ç»¼åˆå¾— $m=-2$ã€‚",
                variant: {
                    question: "è‹¥ $ y=(k+1)x^2 $ å¼€å£å‘ä¸‹ï¼Œåˆ™ $k$ï¼Ÿ",
                    options: ["$ k>-1 $", "$ k<-1 $", "$ k=-1 $", "$ k\\neq-1 $"],
                    correct: 1
                },
                stepByStep: [
                    "ç¬¬ä¸€æ­¥ï¼šå¼€å£å‘ä¸‹ $\\rightarrow$ ç³»æ•° $a < 0$ã€‚",
                    "ç¬¬äºŒæ­¥ï¼šè¿™é‡Œ $a = k+1$ã€‚",
                    "ç¬¬ä¸‰æ­¥ï¼šè§£ä¸ç­‰å¼ $k+1 < 0$ï¼Œå¾— $k < -1$ã€‚"
                ]
            }
        },
        {
            id: "S-Mix-02", type: "main",
            question: "$ y=-x^2 $ å³ç§»1ï¼Œä¸Šç§»2ï¼Œå¾—åˆ°ï¼Ÿ",
            options: ["$ y=-(x+1)^2+2 $", "$ y=-(x-1)^2+2 $", "$ y=-(x-1)^2-2 $", "$ y=-(x+1)^2-2 $"],
            correct: 1, 
            remediation: {
                explanation: "å·¦åŠ å³å‡ï¼Œä¸ŠåŠ ä¸‹å‡ã€‚<br>å³ç§»1 $\\rightarrow (x-1)$ï¼›ä¸Šç§»2 $\\rightarrow$ å°¾å·´$+2$ã€‚",
                variant: {
                    question: "$ y=-(x-1)^2+3 $ å·¦ç§»1ä¸ªå•ä½åæ˜¯ï¼Ÿ",
                    options: ["$ y=-x^2+3 $", "$ y=-(x-2)^2+3 $", "$ y=-(x-1)^2+2 $", "$ y=-(x-1)^2+4 $"],
                    correct: 0
                },
                stepByStep: [
                    "ç¬¬ä¸€æ­¥ï¼šå‘å·¦ç§»1ï¼Œæ ¹æ®â€œå·¦åŠ â€ï¼Œxå˜æˆ $(x+1)$ã€‚",
                    "ç¬¬äºŒæ­¥ï¼šåŸå¼é‡Œæ˜¯ $(x-1)$ï¼Œç°åœ¨å˜æˆ $(x-1+1)$ï¼Œä¹Ÿå°±æ˜¯ $x$ã€‚",
                    "ç¬¬ä¸‰æ­¥ï¼šå°¾å·´ä¸åŠ¨ï¼Œè¿˜æ˜¯ $+3$ã€‚ç»“æœ $y=-x^2+3$ã€‚"
                ]
            }
        }
    ];

    // =========================================================
    // æ ¸å¿ƒé€»è¾‘æ§åˆ¶
    // =========================================================
    let userAnswers = [];
    let wrongIndices = [];
    let currentQuizIndex = 0;
    let currentRemedyIndex = 0;
    let criticalFailures = 0; // è®°å½•æœ€ç»ˆè¿˜æ²¡å­¦ä¼šçš„é¢˜æ•°

    // --- 1. æ•™å­¦ -> æµ‹è¯• ---
    function startQuiz() {
        switchScene('scene-quiz');
        loadQuizQuestion();
    }

    // --- 2. æµ‹è¯•é€»è¾‘ ---
    function loadQuizQuestion() {
        const q = questionBank[currentQuizIndex];
        document.getElementById('quiz-progress-text').innerText = `${currentQuizIndex + 1} / ${questionBank.length}`;
        document.getElementById('quiz-progress-fill').style.width = `${((currentQuizIndex+1)/questionBank.length)*100}%`;
        document.getElementById('quiz-question-text').innerHTML = q.question;
        
        const container = document.getElementById('quiz-options-container');
        container.innerHTML = '';
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-opt';
            btn.innerHTML = opt;
            btn.onclick = () => selectQuizOption(idx, btn);
            container.appendChild(btn);
        });

        document.getElementById('quiz-next-btn').style.display = 'none';
        renderMath();
    }

    function selectQuizOption(idx, btn) {
        document.querySelectorAll('#quiz-options-container .btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        userAnswers[currentQuizIndex] = idx;
        
        const nextBtn = document.getElementById('quiz-next-btn');
        nextBtn.style.display = 'block';
        if (currentQuizIndex === questionBank.length - 1) {
            nextBtn.innerText = "æäº¤è¯•å·";
            nextBtn.onclick = submitQuiz;
        } else {
            nextBtn.innerText = "ä¸‹ä¸€é¢˜";
            nextBtn.onclick = () => { currentQuizIndex++; loadQuizQuestion(); };
        }
    }

    // --- 3. æäº¤ä¸åˆ¤åˆ† ---
    function submitQuiz() {
        wrongIndices = [];
        questionBank.forEach((q, idx) => {
            if (userAnswers[idx] !== q.correct) wrongIndices.push(idx);
        });

        if (wrongIndices.length === 0) {
            showResult(true);
        } else {
            alert(`ä½ åšå¯¹äº† ${questionBank.length - wrongIndices.length} é“é¢˜ã€‚æœ‰ ${wrongIndices.length} é“é¢˜éœ€è¦è¿›å…¥ã€æ·±åº¦è¯Šç–—ã€‘ç¯èŠ‚ã€‚`);
            startRemediation();
        }
    }

    // --- 4. è¡¥æ•‘é€»è¾‘ (å«äºŒçº§å¹²é¢„) ---
    function startRemediation() {
        currentRemedyIndex = 0;
        criticalFailures = 0;
        switchScene('scene-remedy');
        loadRemedyItem();
    }

    function loadRemedyItem() {
        const idx = wrongIndices[currentRemedyIndex];
        const data = questionBank[idx];
        
        // å¡«å……å†…å®¹
        document.getElementById('remedy-original-question').innerHTML = data.question;
        document.getElementById('remedy-explanation').innerHTML = data.remediation.explanation;
        document.getElementById('variant-question-text').innerHTML = data.remediation.variant.question;
        
        // é‡ç½®çŠ¶æ€
        document.getElementById('deep-dive-box').style.display = 'none';
        document.getElementById('remedy-next-btn').style.display = 'none';
        document.getElementById('variant-feedback').innerHTML = '';
        
        renderVariantOptions(data, false);
        renderMath();
    }

    function renderVariantOptions(data, isRetry) {
        const container = document.getElementById('variant-options-container');
        container.innerHTML = '';
        data.remediation.variant.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-opt';
            btn.innerHTML = opt;
            btn.onclick = () => checkVariantAnswer(idx, btn, data, isRetry);
            container.appendChild(btn);
        });
        renderMath();
    }

    function checkVariantAnswer(userIdx, btn, data, isRetry) {
        const correctIdx = data.remediation.variant.correct;
        const allBtns = document.querySelectorAll('#variant-options-container .btn');
        allBtns.forEach(b => b.classList.add('disabled')); // é”æ­»

        if (userIdx === correctIdx) {
            // ç­”å¯¹
            btn.style.backgroundColor = '#dcedc8'; btn.style.borderColor = '#2e7d32';
            document.getElementById('variant-feedback').innerHTML = '<span style="color:green">âœ… æŒ‘æˆ˜æˆåŠŸï¼çŸ¥è¯†ç‚¹å·²ä¿®å¤ã€‚</span>';
            document.getElementById('remedy-next-btn').style.display = 'inline-block';
        } else {
            // ç­”é”™
            btn.style.backgroundColor = '#ffcdd2'; btn.style.borderColor = '#c62828';
            
            if (!isRetry) {
                // ç¬¬ä¸€æ¬¡é”™ -> è§¦å‘æ·±åº¦å¹²é¢„
                document.getElementById('variant-feedback').innerHTML = '<span style="color:#c62828">âŒ ä¾ç„¶é”™è¯¯ã€‚è¯·é˜…è¯»ä¸‹æ–¹çš„ã€åˆ†æ­¥æ‹†è§£ã€‘ï¼Œç„¶åé‡è¯•ã€‚</span>';
                showDeepDive(data);
            } else {
                // é‡è¯•è¿˜é”™ -> å½»åº•å¤±è´¥
                criticalFailures++;
                allBtns[correctIdx].style.backgroundColor = '#dcedc8'; // æ˜¾ç¤ºæ­£è§£
                document.getElementById('variant-feedback').innerHTML = '<span style="color:red">ğŸ†˜ æ­¤é¢˜é‡è¯•ä¾ç„¶é”™è¯¯ã€‚è¯·åŠ¡å¿…æˆªå›¾é—®è€å¸ˆï¼</span>';
                document.getElementById('remedy-next-btn').style.display = 'inline-block';
            }
        }
    }

    function showDeepDive(data) {
        const box = document.getElementById('deep-dive-box');
        const stepsDiv = document.getElementById('deep-steps');
        stepsDiv.innerHTML = '';
        
        data.remediation.stepByStep.forEach(step => {
            const div = document.createElement('div');
            div.className = 'step-item';
            div.innerHTML = step;
            stepsDiv.appendChild(div);
        });
        
        box.style.display = 'block';
        renderMath();
        // æ»šåŠ¨åˆ°åº•éƒ¨
        box.scrollIntoView({behavior: "smooth"});
    }

    function retryVariant() {
        const idx = wrongIndices[currentRemedyIndex];
        const data = questionBank[idx];
        
        // éšè—æ·±åº¦æ¡†ï¼Œé‡ç½®åé¦ˆ
        document.getElementById('deep-dive-box').style.display = 'none';
        document.getElementById('variant-feedback').innerHTML = '';
        
        // é‡æ–°æ¸²æŸ“é€‰é¡¹ (isRetry = true)
        renderVariantOptions(data, true);
    }

    function nextRemedyItem() {
        currentRemedyIndex++;
        if (currentRemedyIndex < wrongIndices.length) {
            loadRemedyItem();
        } else {
            showResult(false);
        }
    }

    // --- 5. ç»“æœé¡µ ---
    function showResult(isPerfect) {
        switchScene('scene-result');
        const div = document.getElementById('result-details');
        if (isPerfect) {
            div.innerHTML = "<h3 style='color:green'>å®Œç¾é€šå…³ï¼ğŸ‰</h3><p>ä½ çš„åŸºç¡€éå¸¸æ‰å®ï¼Œæ— éœ€ä»»ä½•è¡¥æ•‘ã€‚</p>";
        } else {
            let html = `<h3>å­¦ä¹ æŠ¥å‘Š</h3>`;
            html += `<p>åˆæµ‹å¾—åˆ†ï¼š${questionBank.length - wrongIndices.length} / ${questionBank.length}</p>`;
            html += `<p>å·²å®Œæˆ ${wrongIndices.length} ä¸ªçŸ¥è¯†ç‚¹çš„è¯Šç–—ã€‚</p>`;
            
            if (criticalFailures > 0) {
                html += `<div style="background:#ffebee; padding:10px; border-left:4px solid red; margin-top:10px;">
                            <strong>ğŸš¨ ä¸¥é‡è­¦æŠ¥ï¼š</strong><br>æœ‰ ${criticalFailures} ä¸ªçŸ¥è¯†ç‚¹åœ¨â€œåˆ†æ­¥æ‹†è§£â€åä¾ç„¶æœªæŒæ¡ã€‚è¯·åŠ¡å¿…è”ç³»è€å¸ˆè¾…å¯¼ï¼
                         </div>`;
            } else {
                html += `<div style="background:#e8f5e9; padding:10px; border-left:4px solid green; margin-top:10px;">
                            <strong>âœ… ä¿®å¤å®Œæˆï¼š</strong><br>æ‰€æœ‰ç›²åŒºéƒ½å·²é€šè¿‡å˜å¼é¢˜ä¿®æ­£ã€‚åšå¾—å¥½ï¼
                         </div>`;
            }
            div.innerHTML = html;
        }
    }

    // --- å·¥å…·å‡½æ•° ---
    function switchScene(id) {
        document.querySelectorAll('.scene').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0, 0);
    }
    
    function renderMath() {
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) MathJax.typesetPromise();
    }
</script>

</body>
</html>
